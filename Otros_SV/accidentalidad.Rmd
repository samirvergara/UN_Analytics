---
title: "Análisis de Accidentalidad"
author: "Samir Vergara Posada"
date: "20/9/2019"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Análisis de accidentalidad con los datos abiertos
En este archivo se visualizan algunas características de la accidentalidad en el municiío de Medellín.

### Carga de los datos
El siguiente código muestra cómo cargar los datos de accidentalidad descargados en sitio de [Medata](http://medata.gov.co/dataset/accidentalidad/resource/18148d31-619b-4676-8646-4df5c8c4d671#{view-graph:{graphOptions:{hooks:{processOffset:{},bindEvents:{}}}},graphOptions:{hooks:{processOffset:{},bindEvents:{}}},view-map:{geomField:!location}})

```{r}
accidentalidad <- read.csv("accidentalidad.csv", header = TRUE, sep = ";", encoding = "UTF-8")
```

### Filtrado de los choques en Belén

```{r}
choques_rosales<-subset(accidentalidad, subset = (CLASE_ACCIDENTE=="Choque" & barrio =="Rosales"))
```

Conteo del número de accidentes por mes:

```{r}
consolidado_rosales<-table(choques_rosales$Año, choques_rosales$Mes)
```

Accidentalidad en rosales como imagen

```{r}
image(t(consolidado_rosales[6:1,]), 
      #unicol = rainbow(25), 
      xlab = "Meses", 
      ylab = "Años", 
      axes=F)
#axis(1, at=seq(0, 1, length.out = 12), labels = colnames(consolidado_rosales))
axis(1, at=seq(0, 1, length.out = 12), labels = c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                                                  "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"),
     las=2)
axis(2, at=seq(0, 1, length.out = 6 ), labels = rownames(consolidado_rosales), las=1)


```

### Previsualización de la base cargada

```{r echo=FALSE}
head(accidentalidad)
```



#### Base de datos filtrada: Barrio = Rosales

```{r echo=FALSE}
head(choques_rosales)

```

* La base de accidentalidad tiene `r dim(accidentalidad)[1]` filas y `r dim(accidentalidad)[2]` columnas.

```{r}
dim(choques_rosales)

```


#### Lista de campos base de datos abierta: Accidentalidad

```{r echo=FALSE}
names(accidentalidad)

```
```{r}

```

<!-- 
Para comentariar: Se hace la selección y se presiona Shift + Ctrl + C
-->

## Análisis de la serie de tiempos

Extracción de la fecha de los choques
```{r}
choques_rosales$f_accidente<-substr(choques_rosales$FECHA_ACCIDENTE, 1, 10)
choques_rosales$f_accidente<-as.Date(choques_rosales$FECHA_ACCIDENTE, format="%Y-%m-%d")
```

### Filtrado de los choques en El Poblado

```{r}
choques_el_poblado<-subset(accidentalidad, subset = (CLASE_ACCIDENTE=="Choque" & barrio =="El Poblado"))
```

Conteo del número de accidentes por mes:

```{r}
consolidado_el_poblado<-table(choques_el_poblado$Año, choques_el_poblado$Mes)
```

## Análisis de la serie de tiempos

Extracción de la fecha de los choques
```{r}
choques_el_poblado$f_accidente<-substr(choques_el_poblado$FECHA_ACCIDENTE, 1, 10)
choques_el_poblado$f_accidente<-as.Date(choques_el_poblado$FECHA_ACCIDENTE, format="%Y-%m-%d")

accidentes_dia<-aggregate(CLASE_ACCIDENTE~f_accidente, data=choques_el_poblado, FUN=length)

accidentes_dia

```

¿Cuáles son las fechas de mayor accidentalidad?

```{r}
orden_accidentes_dia<-sort(accidentes_dia$CLASE_ACCIDENTE, decreasing =TRUE, index.return=TRUE)
#orden_acc$x

accidentes_dia[orden_accidentes_dia$ix,]

```

```{r}
plot(accidentes_dia$f_accidente, accidentes_dia$CLASE_ACCIDENTE, type="h", ylim = c(0,3), 
     xlab = "Fecha", 
     ylab = "Cantidad de Accidentes",
     main = "Choques por fecha",
     yaxt="n")
     axis(2, at=c(0,1,2,3),labels=c(0,1,2,3), las=1)
     
```
<!-- TAREA: Explorar la función: plotty -->
<!-- TAREA: Mejorar con Kable -->



```{r}
coordenadas<-as.character(choques_el_poblado$location)
coordenadas<-gsub("[","",coordenadas,fixed=TRUE)
coordenadas<-gsub("]","",coordenadas,fixed=TRUE)
coordenadas<-strsplit(coordenadas,split = ",", fixed=TRUE)
coordenadas<-unlist(coordenadas)
coordenadas<-as.numeric(coordenadas)
longitud <-coordenadas[seq(1,length(coordenadas),by=2)]
latitud <-coordenadas[seq(2,length(coordenadas),by=2)]
#longitud<-coordenadas[2]
```



```{r}
plot(latitud, longitud, xlab="Latitud", ylab="Longitud", las=1)
grid()

```

### Mapa con leaflet


```{r}
# Instalar Paquetes en R
#install.packages("leaflet")

# Identifica las funciones de la librería
#library (help="nombre_libreria") 

# 

library(leaflet)
```

<!-- tiles son las capas para los Mapas-->

```{r}
lng1=min(longitud) 
lat1=min(latitud) 
lng2=max(longitud)
lat2=max(latitud) 
```


```{r}

map<-leaflet()
map<-addProviderTiles(map, provider="OpenStreetMap.Mapnik")
map<-addMarkers(map, lat=latitud, lng=longitud)
map<-fitBounds(map, lng1,lat1, lng2, lat2)
   
map

# Inspeccionar de forma visual si los accidentes tienen una temporalidad. Colorear los marcadores

```

```{r}
#"install.packages("leaflet")

# A la variable fecha se le aplica una funcion para el dia de la semana
# addAwesomeMarkers
# No es una buena practica utilizar formulas dentro de los argumentos de una función
# 

# Vamos a detectar


#day(accidentes_dia$f_accidente)

#install.packages("chron")
#library(chron)

#install.packages("lubridate")
#library(lubridate)


fechas<-seq(as.Date("01-01-2014", format="%d-%m-%Y"),
       as.Date("31-12-2019", format="%d-%m-%Y"),
       by = 1)



#head(fechas)

dia_mes <- format(fechas,"%d") # Extrae el dia del mes en formato texto "##"
dia_mes <- as.numeric(dia_mes) # Extrae el dia del mes en formato texto "##"

dia_semana <- weekdays(fechas)

mes_fecha <- format(fechas,"%m") # Extrae el mes de una fecha "##"
mes <- as.numeric(mes_fecha) # Extrae el dia del mes en formato texto "##"

anno <- format(fechas,"%Y") # Extrae el mes de una fecha "##"
anno <- as.numeric(anno) # Extrae el dia del mes en formato texto "##"


es_dia_laboral <-ifelse(dia_semana %in% c("sábado","domingo"),"no laboral","laboral")

#unique(mes_fecha)

seq(0,10, by = 1)
seq(0,10, by = 2)
seq(0,10, by = 0.01)

#seq(as.Date("1910/1/1"), as.Date("1999/1/1"), "years")

#dia_semana
#es_dia_laboral

#cbind(dia_semana, es_dia_laboral)
#head(cbind(dia_semana,es_dia_laboral))

#table(dia_semana, es_dia_laboral)

#table(accidentes_dia,dia_semana, es_dia_laboral)

#head(cbind(accidentes_dia,dia_semana, es_dia_laboral))

#cbind(accidentes_dia,dia_semana, es_dia_laboral)

FECHAS<-data.frame(fechas,es_dia_laboral,dia_mes, mes, anno, dia_semana )

solo_dias_laborales = subset(FECHAS, subset=(es_dia_laboral=="laboral"))

#head(FECHAS)
#class(FECHAS)

ultimos_dias_habiles <- aggregate(dia_mes~mes*anno, data=solo_dias_laborales, FUN=max)

#head(ultimos_dias_habiles)

# Funciona + o * -> anno*mes o anno+mes
# Se agrupa o agregan las variables finitas: Ej: Años, Meses
# No se pueden agregar variables continuas, a menos que definas rangos


```

```{r}
# Comparaciones n x m

n<-length(fechas)
m<-dim(ultimos_dias_habiles)[1]

es_ultimo_dia_habil<-rep(0,n)

for (i in 1:n){
  for (j in 1:m){
                  if(FECHAS$dia_mes[i] == ultimos_dias_habiles$dia_mes[j] & 
                    FECHAS$mes[i] == ultimos_dias_habiles$mes[j] & 
                    FECHAS$anno[i] == ultimos_dias_habiles$anno[j]
                    )
                     {
                     es_ultimo_dia_habil[i] = 1
                     }

  } 
}
es_ultimo_dia_habil

```

```{r}

# Esta es la forma de agregar campos a un data.frame
# FECHAS$es_ultimo_dia_habil <- esultimodiahabil

```

```{r}

accidentalidad$f_accidente<-substr(choques_rosales$FECHA_ACCIDENTE, 1, 10)

accidentalidad$f_accidente<-as.Date(choques_rosales$FECHA_ACCIDENTE, format="%Y-%m-%d")

accidentalidad_enriquecidad <-merge(accidentalidad,FECHAS, by.x="f_accidente", by.y="fechas")

```

